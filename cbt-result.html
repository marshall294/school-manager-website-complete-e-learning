<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CBT Results Broadsheet | ORLI Academy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-green-50 min-h-screen p-6">

  <!-- Header -->
  <header class="bg-green-700 text-white py-4 px-6 rounded-lg shadow mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
    <div>
      <h1 class="text-2xl font-bold">ORLI International Academy</h1>
      <p class="text-sm opacity-80">CBT Results Broadsheet</p>
    </div>
    <button onclick="exportCSV()" class="bg-lime-600 hover:bg-lime-700 transition text-white px-4 py-2 rounded mt-3 sm:mt-0">
      Export CSV
    </button>
  </header>

  <!-- Filters -->
  <section class="bg-white p-5 rounded-lg shadow mb-6">
    <h2 class="font-semibold text-lg text-gray-700 mb-4">Filter by Academic Year and Term</h2>
    <div class="flex flex-wrap gap-4">
      <select id="year" class="border border-gray-300 p-2 rounded-lg text-gray-700 w-full sm:w-auto">
        <option value="">-- Select Year --</option>
      </select>
      <select id="term" class="border border-gray-300 p-2 rounded-lg text-gray-700 w-full sm:w-auto">
        <option value="">-- Select Term --</option>
      </select>
      <button onclick="loadResults()" class="bg-green-600 hover:bg-green-700 transition text-white px-5 py-2 rounded-lg">
        Load Results
      </button>
    </div>
  </section>

  <!-- Assessment Info -->
  <div id="assessmentInfo" class="hidden bg-lime-50 border-l-4 border-lime-600 p-4 rounded-lg text-gray-800 mb-6"></div>

  <!-- Results Table -->
  <section id="tableSection" class="overflow-x-auto bg-white p-5 rounded-lg shadow hidden">
    <h3 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Student Broadsheet</h3>
    <table id="resultsTable" class="min-w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
      <thead id="thead" class="bg-green-50 text-gray-700 text-xs uppercase tracking-wide"></thead>
      <tbody id="tbody" class="text-gray-700"></tbody>
    </table>
  </section>

  <!-- Summary Section -->
  <section id="summaryContainer" class="mt-8 hidden bg-white p-5 rounded-lg shadow">
    <h3 class="font-semibold text-lg text-gray-800 mb-4 border-b pb-2">Summary</h3>
  </section>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyC3Ef_ZnjmU_X2JJDbUlDYv6enGkuuW2n0",
      authDomain: "school-6425b.firebaseapp.com",
      databaseURL: "https://school-6425b-default-rtdb.firebaseio.com",
      projectId: "school-6425b",
      storageBucket: "school-6425b.appspot.com",
      messagingSenderId: "929265479935",
      appId: "1:929265479935:web:af45ea5968ee50258a1cca"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let teacherClass = "";
    let filteredCBTs = [];
    const filters = ["year", "term"];
    const selected = {};

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "login.html";
      db.ref(`users/${user.uid}`).once("value").then(snap => {
        const data = snap.val();
        if (!data || data.role !== 'teacher') return location.href = 'dashboard.html';
        teacherClass = data.class;
        loadValidCBTs();
      });
    });

    function loadValidCBTs() {
      db.ref("cbtBank").once("value").then(cbtSnap => {
        const allCBTs = Object.entries(cbtSnap.val() || {}).map(([id, val]) => ({ ...val, id }));
        const classCBTs = allCBTs.filter(cbt => cbt.published && cbt.class === teacherClass);

        db.ref("results").once("value").then(resultSnap => {
          const resultList = Object.values(resultSnap.val() || {});
          const validIds = new Set(resultList.map(r => r.cbtId));
          filteredCBTs = classCBTs.filter(cbt => validIds.has(cbt.id));

          const sets = { year: new Set(), term: new Set() };
          filteredCBTs.forEach(item => filters.forEach(f => item[f] && sets[f].add(item[f])));

          filters.forEach(f => {
            const sel = document.getElementById(f);
            sel.innerHTML = `<option value="">-- Select ${f} --</option>`;
            Array.from(sets[f]).sort().forEach(v => {
              sel.innerHTML += `<option value="${v}">${v}</option>`;
            });
          });
        });
      });
    }

    function getGrade(avg) {
      avg = parseFloat(avg);
      if (avg >= 70) return "A";
      if (avg >= 60) return "B";
      if (avg >= 50) return "C";
      if (avg >= 45) return "D";
      if (avg >= 40) return "E";
      return "F";
    }

    function loadResults() {
      filters.forEach(f => selected[f] = document.getElementById(f).value);
      if (!selected.year || !selected.term) {
        alert("Please select academic year and term.");
        return;
      }

      const infoBox = document.getElementById("assessmentInfo");
      const tableSection = document.getElementById("tableSection");
      const summaryContainer = document.getElementById("summaryContainer");
      const thead = document.getElementById("thead");
      const tbody = document.getElementById("tbody");

      infoBox.classList.add("hidden");
      tableSection.classList.add("hidden");
      summaryContainer.classList.add("hidden");

      const matches = filteredCBTs.filter(cbt =>
        cbt.year === selected.year &&
        cbt.term === selected.term &&
        cbt.class === teacherClass
      );

      if (!matches.length) {
        infoBox.classList.remove("hidden");
        infoBox.innerHTML = `<strong>No results</strong> found for selected filters.`;
        return;
      }

      const subjects = [...new Set(matches.map(cbt => cbt.subject))].sort();
      const subjectMap = {};
      matches.forEach(cbt => {
        if (!subjectMap[cbt.subject]) subjectMap[cbt.subject] = {};
        subjectMap[cbt.subject][cbt.type] = cbt;
      });

      db.ref("results").once("value").then(snap => {
        const allResults = Object.values(snap.val() || {});
        const studentMap = {};

        allResults.forEach(res => {
          const cbt = matches.find(c => c.id === res.cbtId);
          if (!cbt) return;
          const { subject, type } = cbt;
          const student = res.student;
          const answers = res.answers || [];

          let correct = 0;
          cbt.questions.forEach((q, i) => {
            if ((answers[i] || "").toLowerCase() === (q.answer || "").toLowerCase()) correct++;
          });

          const rawScore = (correct / cbt.questions.length) * 100;
          if (!studentMap[student]) studentMap[student] = {};
          if (!studentMap[student][subject]) studentMap[student][subject] = {};
          studentMap[student][subject][type] = rawScore;
        });

        // Create table header
        let headerHTML = `<tr><th rowspan="2" class="p-3 border bg-green-100 text-left font-semibold">Student</th>`;
        subjects.forEach(sub => {
          headerHTML += `<th colspan="5" class="p-3 border bg-green-100 text-center font-semibold">${sub}</th>`;
        });
        headerHTML += `<th rowspan="2" class="p-3 border bg-green-100 text-center font-semibold">Total</th>
                       <th rowspan="2" class="p-3 border bg-green-100 text-center font-semibold">Average</th>
                       <th rowspan="2" class="p-3 border bg-green-100 text-center font-semibold">Grade</th></tr><tr>`;
        subjects.forEach(() => {
          headerHTML += `<th class="p-2 border text-xs">CA1</th>
                         <th class="p-2 border text-xs">CA2</th>
                         <th class="p-2 border text-xs">Assign</th>
                         <th class="p-2 border text-xs">Proj</th>
                         <th class="p-2 border text-xs">Exam</th>`;
        });
        headerHTML += "</tr>";
        thead.innerHTML = headerHTML;

        // Rows per student
        tbody.innerHTML = "";
        const subjectStats = {};

        Object.entries(studentMap).forEach(([student, subjScores]) => {
          let row = `<tr class="even:bg-gray-50 hover:bg-gray-100 transition"><td class="p-3 border font-semibold">${student}</td>`;
          let totalAll = 0, count = 0;

          subjects.forEach(sub => {
            const sc = subjScores[sub] || {};
            const ca1 = Math.min((sc["CA 1"] || 0) * 0.2, 20);
            const ca2 = Math.min((sc["CA 2"] || 0) * 0.2, 20);
            const asg = Math.min((sc["Assignment"] || 0) * 0.1, 10);
            const prj = Math.min((sc["Project"] || 0) * 0.1, 10);
            const exm = Math.min((sc["Examination"] || 0) * 0.4, 40);
            const total = +(ca1 + ca2 + asg + prj + exm).toFixed(2);

            if (!subjectStats[sub]) subjectStats[sub] = [];
            subjectStats[sub].push(total);

            if (total > 0) { totalAll += total; count++; }

            row += `<td class="p-2 border text-center">${ca1.toFixed(1)}</td>
                    <td class="p-2 border text-center">${ca2.toFixed(1)}</td>
                    <td class="p-2 border text-center">${asg.toFixed(1)}</td>
                    <td class="p-2 border text-center">${prj.toFixed(1)}</td>
                    <td class="p-2 border text-center">${exm.toFixed(1)}</td>`;
          });

          const avg = count ? (totalAll / count).toFixed(2) : "0.00";
          const grade = getGrade(avg);
          row += `<td class="p-2 border text-center font-semibold">${totalAll.toFixed(2)}</td>
                  <td class="p-2 border text-center">${avg}</td>
                  <td class="p-2 border text-center font-bold ${
                    grade === "A" ? "text-green-600" :
                    grade === "B" ? "text-blue-600" :
                    grade === "C" ? "text-yellow-600" :
                    grade === "D" ? "text-orange-600" :
                    "text-red-600"}">${grade}</td></tr>`;

          tbody.insertAdjacentHTML("beforeend", row);
        });

        // Summary
        let summaryHTML = `<div class="overflow-x-auto"><table class="min-w-full text-sm border border-gray-200 rounded-lg">
          <thead class="bg-green-50 text-gray-700 uppercase text-xs tracking-wide">
            <tr><th class="border p-2 text-left">Subject</th><th class="border p-2">Highest</th><th class="border p-2">Lowest</th><th class="border p-2">Average</th></tr>
          </thead><tbody>`;
        for (const [subject, arr] of Object.entries(subjectStats)) {
          const high = Math.max(...arr);
          const low = Math.min(...arr);
          const avg = (arr.reduce((a,b)=>a+b,0)/arr.length).toFixed(2);
          summaryHTML += `<tr class="even:bg-gray-50 hover:bg-gray-100 transition">
            <td class="border p-2">${subject}</td>
            <td class="border p-2 text-center">${high}</td>
            <td class="border p-2 text-center">${low}</td>
            <td class="border p-2 text-center">${avg}</td></tr>`;
        }
        summaryHTML += "</tbody></table></div>";

        summaryContainer.innerHTML = summaryHTML;
        infoBox.innerHTML = `<strong>Showing results for:</strong> ${selected.year}, ${selected.term}`;
        infoBox.classList.remove("hidden");
        tableSection.classList.remove("hidden");
        summaryContainer.classList.remove("hidden");
      });
    }

    // Export CSV
    function exportCSV() {
      const rows = [...document.querySelectorAll("#resultsTable tr")];
      const csv = rows.map(row =>
        [...row.querySelectorAll("th, td")].map(cell => cell.textContent.trim()).join(",")
      ).join("\n");

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `CBT_Results_${selected.year}_${selected.term}.csv`;
      link.click();
    }
  </script>
</body>
</html>
