<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Teacher Theory Assessment | ORLI International Academy</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <div id="unauthorized" class="hidden h-screen flex items-center justify-center">
    <h2 class="text-2xl font-bold text-red-600">Access restricted to teachers only.</h2>
  </div>

  <div id="mainContent" class="hidden max-w-5xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">Theory Assessment Management</h1>

    <div class="bg-white p-6 rounded-xl shadow mb-8">
      <form id="assessmentForm" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block font-semibold">School Name</label>
            <input type="text" id="schoolName" class="w-full border rounded p-2" readonly value="ORLI International Academy">
          </div>
          <div>
            <label class="block font-semibold">Teacher's Class</label>
            <input type="text" id="teacherClass" class="w-full border rounded p-2 bg-gray-100" readonly>
          </div>
          <div>
            <label class="block font-semibold">Academic Year</label>
            <select id="academicYear" class="w-full border rounded p-2"></select>
          </div>
          <div>
            <label class="block font-semibold">Term</label>
            <select id="term" class="w-full border rounded p-2"></select>
          </div>
          <div>
            <label class="block font-semibold">Subject</label>
            <select id="subject" class="w-full border rounded p-2"></select>
          </div>
          <div>
            <label class="block font-semibold">Assessment Type</label>
            <select id="assessmentType" class="w-full border rounded p-2">
              <option value="Test">Test</option>
              <option value="Exam">Exam</option>
              <option value="Assignment">Assignment</option>
            </select>
          </div>
        </div>

        <div class="mt-4">
          <label class="block font-semibold mb-2">Theory Questions</label>
          <div id="questionsContainer" class="space-y-2"></div>
          <button type="button" id="addQuestion" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Question</button>
        </div>

        <div class="mt-4 font-semibold">
          Total Score: <span id="totalScore" class="text-blue-700">0</span>
        </div>

        <button type="submit" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold">Save Assessment</button>
      </form>
    </div>

    <div class="bg-white p-6 rounded-xl shadow">
      <h2 class="text-2xl font-bold mb-4 text-gray-700">My Assessments</h2>
      <div id="assessmentsList" class="overflow-x-auto"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_T2_-Hbn5XrMB2Oce8r9ERkkSmfODdfU",
      authDomain: "school-6425b.firebaseapp.com",
      projectId: "school-6425b",
      storageBucket: "school-6425b.appspot.com",
      messagingSenderId: "927795211463",
      appId: "1:927795211463:web:de170df08b23f70318b69f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const mainContent = document.getElementById("mainContent");
    const unauthorized = document.getElementById("unauthorized");
    const teacherClassInput = document.getElementById("teacherClass");
    const form = document.getElementById("assessmentForm");
    const questionsContainer = document.getElementById("questionsContainer");
    const totalScoreDisplay = document.getElementById("totalScore");
    const assessmentsList = document.getElementById("assessmentsList");

    let teacherUID = null;
    let teacherClass = null;
    let totalScore = 0;

    const calcTotal = () => {
      const scores = [...document.querySelectorAll(".scoreInput")].map(i => parseFloat(i.value) || 0);
      totalScore = scores.reduce((a, b) => a + b, 0);
      totalScoreDisplay.textContent = totalScore;
    };

    document.getElementById("addQuestion").addEventListener("click", () => {
      const div = document.createElement("div");
      div.className = "flex items-center gap-2";
      div.innerHTML = `
        <input type="text" placeholder="Question" class="flex-1 border rounded p-2 questionInput" required>
        <input type="number" placeholder="Score" min="1" class="w-24 border rounded p-2 scoreInput" required>
        <button type="button" class="text-red-600 font-bold removeBtn">âœ–</button>`;
      questionsContainer.appendChild(div);

      div.querySelector(".scoreInput").addEventListener("input", calcTotal);
      div.querySelector(".removeBtn").addEventListener("click", () => {
        div.remove();
        calcTotal();
      });
    });

    async function loadDropdowns() {
      const yearSel = document.getElementById("academicYear");
      const termSel = document.getElementById("term");
      const subjSel = document.getElementById("subject");

      for (const [col, sel] of [
        ["years", yearSel],
        ["terms", termSel],
        ["subjects", subjSel]
      ]) {
        const snap = await getDocs(collection(db, col));
        snap.forEach(doc => {
          const opt = document.createElement("option");
          opt.value = doc.data().name || doc.id;
          opt.textContent = doc.data().name || doc.id;
          sel.appendChild(opt);
        });
      }
    }

    async function loadAssessments() {
      const q = query(collection(db, "theoryAssessments"), where("teacherUID", "==", teacherUID));
      const snap = await getDocs(q);
      let html = `
        <table class="min-w-full border text-sm">
          <thead class="bg-gray-200">
            <tr><th class="p-2">Subject</th><th>Type</th><th>Term</th><th>Year</th><th>Total</th><th>Status</th><th>Action</th></tr>
          </thead><tbody>`;
      snap.forEach(docSnap => {
        const a = docSnap.data();
        html += `
          <tr class="border-t">
            <td class="p-2">${a.subject}</td>
            <td>${a.assessmentType}</td>
            <td>${a.term}</td>
            <td>${a.academicYear}</td>
            <td>${a.totalScore}</td>
            <td>${a.published ? '<span class="text-green-600 font-semibold">Published</span>' : '<span class="text-gray-500">Draft</span>'}</td>
            <td>
              <button class="bg-blue-500 text-white px-2 py-1 rounded publishBtn" data-id="${docSnap.id}">${a.published ? 'Unpublish' : 'Publish'}</button>
              <button class="bg-red-500 text-white px-2 py-1 rounded deleteBtn" data-id="${docSnap.id}">Delete</button>
            </td>
          </tr>`;
      });
      html += "</tbody></table>";
      assessmentsList.innerHTML = html;

      document.querySelectorAll(".publishBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const ref = doc(db, "theoryAssessments", btn.dataset.id);
          const published = btn.textContent === "Unpublish" ? false : true;
          await updateDoc(ref, { published });
          loadAssessments();
        });
      });
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          await deleteDoc(doc(db, "theoryAssessments", btn.dataset.id));
          loadAssessments();
        });
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const questions = [...document.querySelectorAll(".questionInput")].map((el, i) => ({
        question: el.value,
        score: parseFloat(document.querySelectorAll(".scoreInput")[i].value)
      }));

      await addDoc(collection(db, "theoryAssessments"), {
        schoolName: "ORLI International Academy",
        teacherUID,
        teacherClass,
        academicYear: academicYear.value,
        term: term.value,
        subject: subject.value,
        assessmentType: assessmentType.value,
        questions,
        totalScore,
        published: false,
        createdAt: new Date()
      });
      alert("Assessment saved successfully!");
      form.reset();
      questionsContainer.innerHTML = "";
      totalScoreDisplay.textContent = "0";
      loadAssessments();
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (!userDoc.exists() || userDoc.data().role !== "Teacher") {
        unauthorized.classList.remove("hidden");
        return;
      }

      teacherUID = user.uid;
      teacherClass = userDoc.data().class || "Not assigned";
      teacherClassInput.value = teacherClass;
      mainContent.classList.remove("hidden");

      await loadDropdowns();
      await loadAssessments();
    });
  </script>
</body>
</html>
